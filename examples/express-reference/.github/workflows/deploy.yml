name: Deploy with TER Validation

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]

jobs:
  validate-config:
    runs-on: ubuntu-latest
    name: Validate Configuration

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      # =====================================================================
      # THIS IS THE KEY PATTERN: Validate before deploy
      # =====================================================================

      - name: Validate Development Configuration
        if: github.ref == 'refs/heads/staging' || github.event_name == 'pull_request'
        run: npx ter check --env .env.dev --contract .ter.json
        env:
          NODE_ENV: development
          PORT: 3000
          DATABASE_URL: postgresql://user:pass@localhost/db
          API_KEY: '[REDACTED:test-key]'
          JWT_SECRET: '[REDACTED:test-secret]'
          LOG_LEVEL: debug

      - name: Validate Production Configuration
        if: github.ref == 'refs/heads/main'
        run: npx ter check --env .env.prod --contract .ter.prod.json
        env:
          NODE_ENV: production
          PORT: 8080
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          API_KEY: ${{ secrets.API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          LOG_LEVEL: warn
          CORS_ORIGIN: https://example.com
          TLS_CERT_PATH: /etc/ssl/certs/cert.pem
          TLS_KEY_PATH: /etc/ssl/private/key.pem

      # =====================================================================
      # Only proceed to deployment if validation passes
      # =====================================================================

      - name: Deploy to Staging
        if: github.ref == 'refs/heads/staging' && success()
        run: |
          echo "✅ Configuration valid. Deploying to staging..."
          # Your actual deployment command here
          # vercel deploy --prod=false

      - name: Deploy to Production
        if: github.ref == 'refs/heads/main' && success()
        run: |
          echo "✅ Configuration valid. Deploying to production..."
          # Your actual deployment command here
          # vercel deploy --prod

  # =========================================================================
  # Alternative: Run the app with validation (ter run pattern)
  # =========================================================================

  run-with-validation:
    runs-on: ubuntu-latest
    name: Run App with Validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run app with configuration validation
        run: |
          npx ter run --env .env.dev --contract .ter.json -- npm start
        env:
          NODE_ENV: development
          PORT: 3000
          DATABASE_URL: postgresql://user:pass@localhost/db
          REDIS_URL: redis://localhost:6379
          API_KEY: '[REDACTED:test-key]'
          JWT_SECRET: '[REDACTED:test-secret]'
          LOG_LEVEL: debug
        timeout-minutes: 5

  # =========================================================================
  # Generate audit report for compliance
  # =========================================================================

  audit-report:
    runs-on: ubuntu-latest
    name: Generate Audit Report
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Generate configuration audit
        run: |
          echo "=== Configuration Audit Report ===" > audit-report.txt
          echo "Generated: $(date)" >> audit-report.txt
          echo "Commit: ${{ github.sha }}" >> audit-report.txt
          echo "" >> audit-report.txt
          echo "Configuration Schema:" >> audit-report.txt
          cat .ter.prod.json >> audit-report.txt
          echo "" >> audit-report.txt
          echo "Validation Status: PASSED" >> audit-report.txt
          cat audit-report.txt

      - name: Upload audit report
        uses: actions/upload-artifact@v3
        with:
          name: audit-report
          path: audit-report.txt
